<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">　
<title>ハマナの解析，マサキのリサーチ．| Roseanne's Analysis</title>
<link rel="shortcut icon" href="/favicon.ico">
<link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
<style>

.jumbotoron {
  /* プロポーショナルメトリクスを有効にする指定 */
  font-feature-settings: "palt" 1, "dlig" 1;
  background-color: #71b896;
}

</style>
</head>
<body>
<header class="py-3">
  <div class="container text-center">
    <h1><a href="/"<i class="fas fa-glasses text-danger"></i></a></h1>
  </div>
</header>
<nav>
</nav>
<main>
<div class="jumbotoron jumbotron-fluid text-white p-2">
  <div class="container">
    <h4>Roseanne's Analysis
    <small class="text-white-50">ハマナの解析，マサキのリサーチ．</small>
    </h4>
  </div>
</div>

<div class="container">
  <div class="row justify-content-center m-2">
    <large><input type="deck" placeholder="デッキコード カード名 番号" onchange="call_api()" id="update"/></large>
  </div>
  <div class="row justify-content-center m-2">
    <p>Twitterなどに投稿されたデッキを解析してリサーチ。第一弾は似ているデッキを探します。</p>
  </div>
  <div id="deckresult" class="container">
  </div>
</div>
</main>

<template id="deckrow">
  <div class="row py-4" data-title="NEW" >
    <div class="col-10 record">
      <figure><img class="img-fluid img-thumbnail" onclick="move_to(this);"/></figure><span></span>
    </div>
    <div class="col-2 row-op">
      <a target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i></a>
    </div>
  </div>
</template> 
</body>
<script>
var update_text = document.querySelector('#update');

update_text.focus();

function insert_item(item) {
  var pivot = document.querySelector('#deckresult');
  var template = document.querySelector('#deckrow');
  var clone = document.importNode(template.content, true);
  var img = clone.querySelector("img")
  var a = clone.querySelector("a");
  var span = clone.querySelector("span")
  img.src = item['image'];
  a.href = item['link'];
  span.textContent = item['score'].toFixed(3) + " " + item["name"] + " " + item['diff'];
  // td[2].textContent = item['ean'];

  pivot.appendChild(clone);
  var newone = pivot.querySelector('div[data-title="NEW"]:last-child');
  console.log(newone);
  for (let key in item) {
    newone.dataset[key] = item[key];
  }
}

function apply_state(state) {
  var pivot = document.querySelector('#deckresult');
  while( pivot.firstChild ){
    pivot.removeChild( pivot.firstChild );
  }
  for(item in state) {
    insert_item(state[item]);
  }
}

function call_set_deck_code(name) {
  url = '/api';

  data = {
    deck: name
  };

  fetch(url, {
    method: "POST",
    credentials: "same-origin",
    headers: {
      "Content-Type": "application/json; charset=utf-8",
    },
    body: JSON.stringify(data), 
  })
  .then(res => res.json())
  .then(response => apply_state(response)); 

  update_text.value = "";
  update_text.focus();
}

function call_api() {
  call_set_deck_code(update_text.value);
}

function move_to(me) {
  var node;
  node = me.parentNode.parentNode.parentNode;
  console.log(node.dataset['name']);
  update_text.value = node.dataset['name'];
  call_api(node.dataset['name']);
}

</script>
</html>